---
title: Visualizing COVID-19 Data Using R
output: html_document
knit: (function(inputFile, encoding) { 
  rmarkdown::render(inputFile,
    encoding=encoding, output_file='index.html') })
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

Researchers at [Our World in Data](https://ourworldindata.org/coronavirus-source-data) have aggregated data on COVID-19 cases, deaths, vaccinations, etc from various sources such as WHO and Johns Hopkins University, and made it available in a GitHub repository.

I will be using this dataset to visualize various COVID-19 related metrics, and also test some hypotheses relating to the nature of COVID-19 cases. More than anything, I see this as an exercise in working with R and applying some of the statistics knowledge I've learned.

```{r, include=FALSE}
library(tidyverse)
```

### Total Per-Capita COVID-19 cases in Canada over time

First, I'll import the dataset as such.

```{r, message=FALSE, cache=TRUE}
total_cases_per_million <- read_csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/jhu/total_cases_per_million.csv")
```

The raw data has each country's cases in its own column, and dates in rows. To tidy this data, I'll first filter out only the relevant countries and gather the country info under one column.

```{r}
canada_cases <- total_cases_per_million %>%
  select(date, World, Canada, `United States`) %>%
  gather(key = country, value = cases, -date)
```

Now, this data can be visualized using `ggplot2`.

```{r, fig.align="center"}
ggplot(canada_cases, aes(x = date, y = cases)) +
  geom_line(aes(color = country)) +
  scale_y_log10() +
  scale_x_date(date_labels = "%b %y", date_breaks = "2 months",
    guide = guide_axis(angle = 60)) +
  labs(title = "Total Per-Capita COVID-19 Cases Over Time",
    x = "Time", y = "Confirmed COVID-19 cases (per million)",
    caption = "Source: Our World in Data")
```

### New Per-Capita COVID-19 Cases in Canada over Time

As I did before, I'll import the relevant data from OWID.

```{r, message=FALSE, cache=TRUE}
new_cases_per_million <- read_csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/jhu/new_cases_per_million.csv")
```

Everything I mentioned about the formatting of the other CSV file holds true for this, too. Each country's data is in its own column, and each date's data are in their own rows.

```{r}
canada_new_cases <- new_cases_per_million %>%
  select(date, World, Canada, `United States`) %>%
  gather(key = country, value = cases, -date)
```

Now, this data can be plotted. However, if I use the same method as I did with the prior dataset, it is hard to visualize any clear trends due to the fluctuations by week. This is especially apparent after July 2021.

```{r, fig.align="center"}
ggplot(canada_new_cases, aes(x = date, y = cases)) +
  geom_line(aes(color = country)) +
  scale_x_date(date_labels = "%b %y", date_breaks =  "2 months",
    guide = guide_axis(angle = 60)) +
  labs(title = "New Per-Capita COVID-19 Cases Over Time",
    x = "Time", y = "Confirmed COVID-19 cases (per million)",
    caption = "Source: Our World in Data")
```

So, to make the trends more clear, I'll plot the individual data points (as opposed to a line graph) and include a smoothened trendline.

```{r, fig.align="center"}
ggplot(canada_new_cases, aes(x = date, y = cases)) +
  geom_jitter(aes(color = country), size = 0.1) +
  geom_smooth(aes(color = country)) +
  scale_x_date(date_labels = "%b %y", date_breaks =  "2 months",
    guide = guide_axis(angle = 60)) +
  labs(title = "New Per-Capita COVID-19 Cases Over Time",
    x = "Time", y = "Daily COVID-19 cases (per million)",
    caption = "Source: Our World in Data")
```

### COVID-19 Vaccination Data

Now, I'll graph data relating to COVID-19 vaccinations in the aforementioned countries, and later, attempt to draw conclusions from looking at both vaccination and new COVID-19 cases data.

First, I'll import the dataset as usual.

```{r, message=FALSE, cache=TRUE}
vaccine_data <- read_csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/vaccinations/vaccinations.csv")
```

This dataset does not have countries in separate columns, so there isn't any tidying needed, really. Here is a plot of the daily vaccinations per million people over time.

```{r, fig.align="center"}
vaccine_data %>%
  filter(location == "Canada" | location == "United States") %>%
  ggplot(aes(x = date, y = daily_vaccinations_per_million)) +
  geom_line(aes(color = location)) +
  scale_x_date(date_labels = "%b %y", date_breaks =  "2 months",
    guide = guide_axis(angle = 60)) +
  labs(title = "New Per-Capita COVID-19 Vaccinations Over Time",
    x = "Time", y = "Daily vaccinations (per million)",
    caption = "Source: Our World in Data")
```

This data is interesting on its own and says a lot about the two countries' vaccine distribution timelines. However, I feel that this data is more insightful when overlayed with the daily COVID-19 cases data from earlier.

First, I'll combine the two relevant data together to form one tibble.

```{r}
vaccine_vs_cases <- vaccine_data %>%
  select(date, location, daily_vaccinations_per_million) %>%
  rename(country = location) %>%
  left_join(canada_new_cases, by = c("date", "country")) %>%
  filter(country == "Canada" | country == "United States")
```

Now, I'll overlay the daily per-capita vaccinations data with daily per-capita COVID-19 cases, and view this data for both countries:

```{r, fig.align="center"}
ggplot(vaccine_vs_cases, aes(x = date)) +
  geom_jitter(aes(y = cases), color = "#E87D72", size = 0.1) +
  geom_smooth(aes(y = cases), color = "#E87D72") +
  geom_line(aes(y = daily_vaccinations_per_million / 10), color = "#56BCC2") +
  scale_y_continuous(name = "Daily COVID-19 cases (per million)",
    sec.axis = sec_axis(~ . * 10, name = "Daily COVID-19 vaccinations (per million)")) +
  facet_wrap(~ country) +
  labs(title = "Daily Per-Capita COVID-19 Cases and Vaccinations Over Time",
    x = "Time", caption = "Source: Our World in Data")
```
